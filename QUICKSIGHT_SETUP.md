# AWS QuickSight Setup for Refi-Ready POC

## Overview

This guide explains how to set up AWS QuickSight to visualize the refinance-ready borrower data generated by the pipeline.

## What is AWS QuickSight?

AWS QuickSight is a cloud-native business intelligence service that allows you to create interactive dashboards and visualizations. It connects directly to your AWS data sources (S3, Athena, RDS, etc.) without requiring data downloads.

## Prerequisites

1. **AWS Account with QuickSight Subscription**
   - QuickSight requires a separate subscription
   - 30-day free trial available
   - Pricing: Standard ($9/user/month), Enterprise ($18/user/month)

2. **Completed Pipeline Execution**
   - Run the data pipeline first: `python scripts/run_pipeline.py`
   - Ensure Athena view `unified_refi_dataset` exists

3. **IAM Permissions**
   - QuickSight admin access
   - S3 read permissions for the POC bucket

## Quick Start

### Step 1: Run the QuickSight Setup Script

```bash
python scripts/setup_quicksight.py
```

This script will:
- ✓ Check QuickSight subscription status
- ✓ Grant QuickSight access to S3 bucket
- ✓ Create Athena data source
- ✓ Create dataset from `unified_refi_dataset` view
- ✓ Provide dashboard creation instructions

### Step 2: Subscribe to QuickSight (if needed)

If you see a message that QuickSight is not subscribed:

1. Visit: https://console.aws.amazon.com/quicksight/
2. Click **"Sign up for QuickSight"**
3. Choose edition:
   - **Standard**: Basic BI features, $9/user/month
   - **Enterprise**: Advanced features (ML insights, row-level security), $18/user/month
4. Configure account:
   - Account name: `refi-ready-analytics`
   - Email: Your AWS account email
   - Region: **us-east-1** (same as POC)
5. Grant permissions:
   - ✓ Enable access to Amazon S3
   - ✓ Select your S3 bucket: `refi-ready-poc-dev`
   - ✓ Enable Athena access
6. Click **"Finish"**

### Step 3: Create Your Dashboard

1. **Open QuickSight Console**
   ```
   https://us-east-1.quicksight.aws.amazon.com/sn/start
   ```

2. **Create New Analysis**
   - Click **"Analyses"** in left menu
   - Click **"New analysis"**
   - Select dataset: **"RefiReadyDataset"**
   - Click **"Create analysis"**

3. **Add Visualizations** (see section below)

4. **Publish Dashboard**
   - Click **"Share"** → **"Publish dashboard"**
   - Name: `Refi-Ready Borrower Dashboard`
   - Click **"Publish"**

5. **Share with Team** (optional)
   - Click **"Share"** on published dashboard
   - Add users by email or AWS account
   - Set permissions (Viewer, Co-owner)

---

## Recommended Dashboard Visualizations

### 1. Executive KPI Tiles (Top Row)

**Purpose**: High-level metrics at a glance

**Visualizations**:
- **Total Refi-Ready Borrowers**
  - Visual type: KPI
  - Value: `Count(borrower_id)`
  - Format: Number with comma separator

- **Total Monthly Savings Potential**
  - Visual type: KPI
  - Value: `Sum(monthly_savings_est)`
  - Format: Currency ($)

- **Average Rate Spread**
  - Visual type: KPI
  - Value: `Average(rate_spread)` where `rate_spread = current_interest_rate - market_rate_offer`
  - Format: Percentage (2 decimals)

- **Average LTV Ratio**
  - Visual type: KPI
  - Value: `Average(ltv_ratio)`
  - Format: Percentage

---

### 2. Borrowers by Marketing Category (Bar Chart)

**Purpose**: See distribution of borrowers across urgency tiers

**Configuration**:
- Visual type: Vertical bar chart
- X-axis: Marketing Category (calculated field)
- Y-axis: `Count(borrower_id)`
- Sort: Descending by count
- Colors: Red (Immediate Action), Orange (Hot Lead), Yellow (Watchlist)

**Calculated Field - Marketing Category**:
```
ifelse(
  ({current_interest_rate} - {market_rate_offer}) > 1.25, 'Immediate Action',
  ({current_interest_rate} - {market_rate_offer}) > 0.75, 'Hot Lead',
  ({current_interest_rate} - {market_rate_offer}) > 0.50, 'Watchlist',
  'Ineligible'
)
```

---

### 3. Rate Comparison Analysis (Scatter Plot)

**Purpose**: Visualize rate spreads and savings opportunities

**Configuration**:
- Visual type: Scatter plot
- X-axis: `current_interest_rate`
- Y-axis: `market_rate_offer`
- Bubble size: `monthly_savings_est`
- Color: Marketing Category (from calculated field above)
- Trend line: Yes (shows diagonal for equal rates)

**Insights**: Points above the trend line have high rate spreads (good candidates)

---

### 4. Top Savings Opportunities (Horizontal Bar Chart)

**Purpose**: Identify individual borrowers with highest savings potential

**Configuration**:
- Visual type: Horizontal bar chart
- Y-axis: `full_name` (calculated: `first_name + ' ' + last_name`)
- X-axis: `monthly_savings_est`
- Sort: Top 10 by savings (descending)
- Format: Currency ($)

---

### 5. Engagement Breakdown (Donut Charts)

**Purpose**: Understand digital engagement levels

**Create 4 separate donut charts**:

a) **Paperless Billing**
   - Group: `paperless_billing`
   - Value: `Count(borrower_id)`

b) **Email Engagement**
   - Group: `email_open_last_30d`
   - Value: `Count(borrower_id)`

c) **Mobile App Usage**
   - Group: `mobile_app_login_last_30d`
   - Value: `Count(borrower_id)`

d) **SMS Opt-In**
   - Group: `sms_opt_in`
   - Value: `Count(borrower_id)`

---

### 6. Savings Distribution (Histogram)

**Purpose**: See distribution of monthly savings amounts

**Configuration**:
- Visual type: Histogram
- X-axis: `monthly_savings_est` (binned automatically)
- Y-axis: `Count(borrower_id)`
- Bins: 10-15 bins
- Format: Currency bins

---

### 7. LTV vs. Rate Spread (Heat Map)

**Purpose**: Identify sweet spot for refinance eligibility

**Configuration**:
- Visual type: Heat map
- Rows: `ltv_ratio` (binned into ranges: 0-60%, 60-70%, 70-80%, >80%)
- Columns: Rate spread bins (0-0.5%, 0.5-1%, 1-1.5%, >1.5%)
- Values: `Count(borrower_id)`
- Color: Gradient (blue to red)

---

## Dashboard Filters

Add these filters to make your dashboard interactive:

1. **Marketing Category Filter**
   - Type: Multi-select dropdown
   - Apply to: All visuals

2. **LTV Ratio Filter**
   - Type: Slider
   - Range: 0-100%
   - Apply to: All visuals

3. **Rate Spread Filter**
   - Type: Slider
   - Range: 0-3%
   - Apply to: All visuals

4. **Engagement Filters**
   - Type: Checkbox (Yes/No)
   - Fields: `paperless_billing`, `email_open_last_30d`, `mobile_app_login_last_30d`, `sms_opt_in`

---

## Calculated Fields Reference

Add these calculated fields to your dataset in QuickSight:

### 1. Rate Spread
```
{current_interest_rate} - {market_rate_offer}
```

### 2. Marketing Category
```
ifelse(
  ({current_interest_rate} - {market_rate_offer}) > 1.25, 'Immediate Action',
  ({current_interest_rate} - {market_rate_offer}) > 0.75, 'Hot Lead',
  ({current_interest_rate} - {market_rate_offer}) > 0.50, 'Watchlist',
  'Ineligible'
)
```

### 3. Full Name
```
concat({first_name}, ' ', {last_name})
```

### 4. LTV Category
```
ifelse(
  {ltv_ratio} <= 60, 'Low Risk (0-60%)',
  {ltv_ratio} <= 70, 'Medium Risk (60-70%)',
  {ltv_ratio} <= 80, 'High Risk (70-80%)',
  'Ineligible (>80%)'
)
```

### 5. Annual Savings
```
{monthly_savings_est} * 12
```

### 6. Digital Engagement Score
```
(ifelse({paperless_billing}, 1, 0) +
 ifelse({email_open_last_30d}, 1, 0) +
 ifelse({mobile_app_login_last_30d}, 1, 0) +
 ifelse({sms_opt_in}, 1, 0))
```

---

## Refresh Strategy

### Direct Query (Default)
- Dashboard queries Athena in real-time
- Always shows latest data
- Slower load times for large datasets
- No additional cost for data storage

### SPICE Import (Alternative)
- Data loaded into QuickSight's in-memory engine
- Faster dashboard performance
- Requires manual/scheduled refresh
- Additional cost: $0.25/GB/month
- Good for: Large datasets, frequent dashboard access

**To switch to SPICE**:
1. Go to **Datasets** → **RefiReadyDataset**
2. Click **Edit dataset**
3. Change **Import mode** to **SPICE**
4. Set refresh schedule (hourly, daily, weekly)

---

## Troubleshooting

### Issue: "Data source connection failed"
**Solution**: 
1. Verify Athena workgroup is `primary`
2. Check S3 bucket policy allows QuickSight access
3. Run: `python scripts/setup_quicksight.py` again

### Issue: "Table 'unified_refi_dataset' not found"
**Solution**:
1. Verify pipeline completed: `python scripts/run_pipeline.py`
2. Check Athena view exists:
   ```sql
   SELECT * FROM refi_ready_db.unified_refi_dataset LIMIT 10;
   ```

### Issue: "Access denied to S3 bucket"
**Solution**:
1. Grant QuickSight S3 permissions:
   - QuickSight console → Manage QuickSight → Security & permissions
   - Click **Add or remove** under S3
   - Select `refi-ready-poc-dev` bucket
   - Click **Update**

### Issue: "No data in dataset"
**Solution**:
1. Verify data in Athena:
   ```sql
   SELECT COUNT(*) FROM refi_ready_db.unified_refi_dataset;
   ```
2. If count > 0, refresh dataset in QuickSight
3. If count = 0, re-run pipeline

---

## Cost Estimation

### QuickSight Costs
- **Author users**: $9-18/user/month (can create/edit dashboards)
- **Reader users**: $0.30/session (view only, max $5/month)
- **SPICE storage**: $0.25/GB/month (if using SPICE)

### POC Estimate (Standard Edition)
- 1 Author: $9/month
- 5 Readers: ~$10/month (assuming 2 sessions/user)
- SPICE (10 MB dataset): <$0.01/month
- **Total**: ~$19/month

### Athena Query Costs
- $5 per TB scanned
- POC dataset: ~1 MB
- Cost per query: ~$0.000005 (negligible)
- Direct Query mode: ~$0.01/month for 100 dashboard loads

---

## Embedding Dashboard (Optional)

To embed the dashboard in your application:

1. **Enable embedding in QuickSight**:
   - Manage QuickSight → Domains and embedding
   - Add your domain

2. **Generate embed URL**:
   ```python
   import boto3
   
   quicksight = boto3.client('quicksight', region_name='us-east-1')
   response = quicksight.generate_embed_url_for_registered_user(
       AwsAccountId='YOUR_ACCOUNT_ID',
       SessionLifetimeInMinutes=600,
       UserArn='arn:aws:quicksight:us-east-1:ACCOUNT_ID:user/default/USERNAME',
       ExperienceConfiguration={
           'Dashboard': {
               'InitialDashboardId': 'DASHBOARD_ID'
           }
       }
   )
   
   embed_url = response['EmbedUrl']
   ```

3. **Embed in HTML**:
   ```html
   <iframe src="EMBED_URL" width="1200" height="800"></iframe>
   ```

---

## Next Steps

1. ✓ Run setup script: `python scripts/setup_quicksight.py`
2. ✓ Subscribe to QuickSight (if needed)
3. ✓ Create dashboard with recommended visualizations
4. ✓ Add calculated fields
5. ✓ Apply filters for interactivity
6. ✓ Publish and share with stakeholders
7. ✓ Set up refresh schedule (if using SPICE)

---

## Additional Resources

- [QuickSight User Guide](https://docs.aws.amazon.com/quicksight/)
- [QuickSight Pricing](https://aws.amazon.com/quicksight/pricing/)
- [QuickSight Best Practices](https://docs.aws.amazon.com/quicksight/latest/user/best-practices.html)
- [Athena + QuickSight Integration](https://docs.aws.amazon.com/quicksight/latest/user/create-a-data-set-athena.html)

---

## Support

For issues with this POC:
- Check troubleshooting section above
- Review pipeline logs: `scripts/run_pipeline.py`
- Verify AWS credentials: `aws sts get-caller-identity`

For QuickSight-specific issues:
- AWS Support (if you have a support plan)
- [QuickSight Community Forums](https://repost.aws/tags/TA4ckwkFI3R-mk_gaT1Q9jKQ/amazon-quick-sight)
